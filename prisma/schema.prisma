generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id             String          @id @default(uuid())
  name           String?
  email          String          @unique
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // Relations
  accounts       Account[]
  dailyLogs      DailyLog[]
  nutritionLogs  NutritionLog[]
  waterLogs      WaterLog[]
  workoutLogs    WorkoutLog[]
  warmupLogs     WarmupLog[]
  progressPhotos ProgressPhoto[]
  deadHangLogs   DeadHangLog[]
  settings       UserSettings?
  exercises      Exercise[]       // User-owned exercises
  routines       WorkoutRoutine[] // User-owned routines
}

model DailyLog {
  id             String   @id @default(uuid())
  date           DateTime
  weight         Float?
  sleepHours     Float?
  sleepQuality   Int?     // 1-5 rating
  mood           String?  // "Good", "Low", "Tired"
  bloated        Boolean  @default(false)
  
  // Computed/Cached aggregates
  proteinTotal   Float    @default(0)
  carbsTotal     Float    @default(0)
  fatsTotal      Float    @default(0)
  waterTotal     Float    @default(0)
  caloriesTotal  Float    @default(0)
  
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  
  // Relations
  dailyReview    DailyReview?
  
  @@unique([userId, date])
  @@index([date])
}

model UserSettings {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id])
  
  // Macro Targets
  proteinTarget    Float    @default(140)
  carbsTarget      Float    @default(200)
  fatsTarget       Float    @default(60)
  caloriesTarget   Float    @default(2000)
  waterTarget      Float    @default(4000)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model InventoryItem {
  id              String         @id @default(uuid())
  name            String         @unique 
  icon            String         // Emoji or lucide name
  proteinPerUnit  Float
  carbsPerUnit    Float          @default(0)
  fatPerUnit      Float          @default(0)
  caloriesPerUnit Float
  volumePerUnit   Float          // e.g. 250ml or 50g
  defaultUnit     String         // "scoop", "g", "ml"
  isActive        Boolean        @default(true)  // For smart disable logic
  maxDailyQty     Float?         // Optional daily limit
  
  logs            NutritionLog[]
}

model NutritionLog {
  id              String        @id @default(uuid())
  timestamp       DateTime      @default(now())
  qty             Float         // Multiplier of unit
  mealType        String?       // "breakfast", "lunch", "dinner", "snack"
  
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  
  userId          String
  user            User          @relation(fields: [userId], references: [id])
}

model Exercise {
  id             String       @id @default(uuid())
  name           String
  defaultReps    Int          @default(10)
  defaultSets    Int          @default(3)
  category       String       // Push, Pull, Legs, Core, or custom
  description    String?
  
  // System vs User-owned
  isSystem       Boolean      @default(false)
  userId         String?
  user           User?        @relation(fields: [userId], references: [id])
  
  // Smart Swap Logic for Pain (Self-relation)
  swapExerciseId String?
  swapExercise   Exercise?         @relation("PainSwap", fields: [swapExerciseId], references: [id])
  parentOf       Exercise[]        @relation("PainSwap")

  workoutLogs    WorkoutLog[]
  routineExercises RoutineExercise[]
  
  @@unique([name, userId])
}

model WorkoutLog {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id])
  
  reps        Int
  weight      Float?
  painLevel   Int?     // 0-10
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// ============================================
// NEW MODELS FOR BODY OS
// ============================================

model WarmupChecklist {
  id          String      @id @default(uuid())
  name        String      @unique
  order       Int
  description String?
  logs        WarmupLog[]
}

model WarmupLog {
  id                String          @id @default(uuid())
  date              DateTime        @default(now())
  warmupChecklistId String
  warmupChecklist   WarmupChecklist @relation(fields: [warmupChecklistId], references: [id])
  completed         Boolean         @default(false)
  userId            String
  user              User            @relation(fields: [userId], references: [id])
  
  @@unique([userId, warmupChecklistId, date])
}

model WaterLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  amount    Float    // in ml
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model WorkoutRoutine {
  id          String            @id @default(uuid())
  name        String
  description String?
  
  // System vs User-owned
  isSystem    Boolean           @default(false)
  userId      String?
  user        User?             @relation(fields: [userId], references: [id])
  
  exercises   RoutineExercise[]
  
  @@unique([name, userId])
}

model RoutineExercise {
  id          String         @id @default(uuid())
  order       Int
  sets        Int            @default(3)
  reps        Int            @default(10)
  restSeconds Int            @default(90)  // Per-exercise rest time
  
  routineId   String
  routine     WorkoutRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  exerciseId  String
  exercise    Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
}

model ProgressPhoto {
  id        String   @id @default(uuid())
  date      DateTime @default(now())
  imagePath String
  type      String   // "front", "side", "back"
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model DeadHangLog {
  id      String   @id @default(uuid())
  date    DateTime @default(now())
  seconds Int
  userId  String
  user    User     @relation(fields: [userId], references: [id])
}

model DailyReview {
  id          String   @id @default(uuid())
  date        DateTime
  tookSoya    Boolean?
  elbowStatus String?  // "Good", "Mild Pain", "Bad"
  notes       String?
  dailyLogId  String   @unique
  dailyLog    DailyLog @relation(fields: [dailyLogId], references: [id])
}
