generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id             String          @id @default(uuid())
  name           String?
  email          String          @unique
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // Relations
  accounts        Account[]
  dailyLogs       DailyLog[]
  nutritionLogs   NutritionLog[]
  waterLogs       WaterLog[]
  warmupLogs      WarmupLog[]
  progressPhotos  ProgressPhoto[]
  deadHangLogs    DeadHangLog[]
  settings        UserSettings?
  exercises       Exercise[]          // User-owned exercises
  routines        WorkoutRoutine[]    // User-owned routines
  workoutSessions WorkoutSession[]    // Workout session history
  inventoryItems  InventoryItem[]     // User-owned inventory items
  blockers        PhysicalBlocker[]   // Body issues/injuries
}

model DailyLog {
  id             String   @id @default(uuid())
  date           DateTime
  weight         Float?
  sleepHours     Float?
  sleepQuality   Int?     // 1-5 rating
  mood           String?  // "Good", "Low", "Tired"
  bloated        Boolean  @default(false)
  
  // Computed/Cached aggregates
  proteinTotal   Float    @default(0)
  carbsTotal     Float    @default(0)
  fatsTotal      Float    @default(0)
  waterTotal     Float    @default(0)
  caloriesTotal  Float    @default(0)
  
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  
  // Relations
  dailyReview    DailyReview?
  
  @@unique([userId, date])
  @@index([date])
}

model UserSettings {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id])
  
  // Macro Targets
  proteinTarget    Float    @default(140)
  carbsTarget      Float    @default(200)
  fatsTarget       Float    @default(60)
  caloriesTarget   Float    @default(2000)
  waterTarget      Float    @default(4000)
  
  // Day Boundary Customization
  dayCutoffHour    Int      @default(5)
  dayCutoffMinute  Int      @default(30)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model InventoryItem {
  id              String         @id @default(uuid())
  name            String          
  icon            String         // Emoji or lucide name
  proteinPerUnit  Float
  carbsPerUnit    Float          @default(0)
  fatPerUnit      Float          @default(0)
  caloriesPerUnit Float
  volumePerUnit   Float          // e.g. 250ml or 50g
  defaultUnit     String         // "scoop", "g", "ml"
  costPerUnit     Float          @default(0) // Track budget (e.g. â‚¹5k/month)
  isActive        Boolean        @default(true)  // For smart disable logic
  maxDailyQty     Float?         // Optional daily limit
  
  // System vs User-owned (like Exercises)
  isSystem        Boolean        @default(false)
  userId          String?
  user            User?          @relation(fields: [userId], references: [id])
  
  logs            NutritionLog[]
  
  @@unique([name, userId])
  @@index([isActive])
}

model NutritionLog {
  id              String        @id @default(uuid())
  timestamp       DateTime      @default(now())
  qty             Float         // Multiplier of unit
  mealType        String?       // "breakfast", "lunch", "dinner", "snack"
  
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  @@index([userId, timestamp])
}

model Exercise {
  id             String       @id @default(uuid())
  name           String
  defaultReps    Int          @default(10)
  defaultSets    Int          @default(3)
  category       String       // Push, Pull, Legs, Core, or custom
  description    String?
  equipment      String?      // "bodyweight", "dumbbell", "barbell", "cable", "machine"
  
  // System vs User-owned
  isSystem       Boolean      @default(false)
  userId         String?
  user           User?        @relation(fields: [userId], references: [id])
  
  // Smart Swap Logic for Pain (Self-relation)
  swapExerciseId String?
  swapExercise   Exercise?         @relation("PainSwap", fields: [swapExerciseId], references: [id])
  parentOf       Exercise[]        @relation("PainSwap")

  routineExercises RoutineExercise[]
  muscles          ExerciseMuscle[]   // Muscle groups targeted
  sessionExercises SessionExercise[]  // Session instances
  
  @@unique([name, userId])
  @@index([isSystem, name])  // For pagination + filtering
  @@index([category])        // For category filtering
  @@index([userId, name])    // For user-specific pagination
}



// ============================================
// NEW MODELS FOR BODY OS
// ============================================

model WarmupChecklist {
  id          String      @id @default(uuid())
  name        String      @unique
  order       Int
  description String?
  logs        WarmupLog[]
}

model WarmupLog {
  id                 String          @id @default(uuid())
  date               DateTime        @default(now())
  warmupChecklistId  String
  warmupChecklist    WarmupChecklist @relation(fields: [warmupChecklistId], references: [id])
  completed          Boolean         @default(false)
  userId             String
  user               User            @relation(fields: [userId], references: [id])
  
  // Link to workout session (session-scoped warmups)
  workoutSessionId   String?
  workoutSession     WorkoutSession? @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, warmupChecklistId, workoutSessionId])
  @@index([workoutSessionId])
}

model WaterLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  amount    Float    // in ml
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId, timestamp])
}

model WorkoutRoutine {
  id          String            @id @default(uuid())
  name        String
  description String?
  
  // System vs User-owned
  isSystem    Boolean           @default(false)
  userId      String?
  user        User?             @relation(fields: [userId], references: [id])
  
  exercises   RoutineExercise[]
  sessions    WorkoutSession[]   // Sessions using this routine
  
  @@unique([name, userId])
  @@index([isSystem, name])  // For pagination
  @@index([userId, name])    // For user-specific pagination
}

model RoutineExercise {
  id          String         @id @default(uuid())
  order       Int
  sets        Int            @default(3)
  reps        Int            @default(10)
  restSeconds Int            @default(90)  // Per-exercise rest time
  
  routineId   String
  routine     WorkoutRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  exerciseId  String
  exercise    Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
}

model ProgressPhoto {
  id        String   @id @default(uuid())
  date      DateTime @default(now())
  imagePath String
  type      String   // "front", "side", "back"
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model DeadHangLog {
  id      String   @id @default(uuid())
  date    DateTime @default(now())
  seconds Int
  userId  String
  user    User     @relation(fields: [userId], references: [id])
}

model DailyReview {
  id          String   @id @default(uuid())
  date        DateTime
  tookSoya    Boolean?
  elbowStatus String?  // "Good", "Mild Pain", "Bad"
  notes       String?
  dailyLogId  String   @unique
  dailyLog    DailyLog @relation(fields: [dailyLogId], references: [id])
}

// ============================================
// WORKOUT SESSION TRACKING SYSTEM
// ============================================

// Reference table for muscle groups (granular anatomy)
model MuscleGroup {
  id          String           @id @default(uuid())
  name        String           @unique // "Upper Chest", "Lats", "Rear Delts", etc.
  majorRegion String           // "Chest", "Back", "Shoulders", "Arms", "Core", "Legs"
  exercises   ExerciseMuscle[]
}

// Join table: Exercise <-> MuscleGroup (many-to-many with isPrimary)
model ExerciseMuscle {
  id            String      @id @default(uuid())
  isPrimary     Boolean     @default(true) // Primary vs Secondary mover
  
  exerciseId    String
  exercise      Exercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  muscleGroupId String
  muscleGroup   MuscleGroup @relation(fields: [muscleGroupId], references: [id])
  
  @@unique([exerciseId, muscleGroupId])
}

// Session status enum
enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

// Central workout session - one per workout attempt
model WorkoutSession {
  id                 String            @id @default(uuid())
  
  // === CALENDAR FIELDS (for easy querying) ===
  date               DateTime          // Just the date (YYYY-MM-DD)
  dayOfWeek          Int               // 0=Sunday, 1=Monday, ..., 6=Saturday
  weekOfYear         Int               // 1-52
  month              Int               // 1-12
  year               Int               // 2024, 2025, etc.
  
  // === TIMING ===
  startedAt          DateTime          @default(now())
  completedAt        DateTime?
  activeSeconds      Int               @default(0)  // Accumulated active workout time (excludes pauses)
  lastActivityAt     DateTime?                      // Last set logged, for delta calculation
  timeOfDay          String?           // "morning", "afternoon", "evening", "night"
  
  // === STATUS (for resume logic) ===
  status             SessionStatus     @default(IN_PROGRESS)
  
  // === PRE-WORKOUT CONTEXT ===
  preWorkoutEnergy   Int?              // 1-5 scale
  sleepLastNight     Float?            // hours
  sleepQuality       Int?              // 1-5 scale
  stressLevel        Int?              // 1-5 scale (life stress)
  soreness           Int?              // 1-5 DOMS level from previous workouts
  fastedWorkout      Boolean           @default(false)
  caffeineIntake     Int?              // mg consumed before workout
  
  // === POST-WORKOUT METRICS ===
  postWorkoutEnergy  Int?              // 1-5 scale
  pumpRating         Int?              // 1-5 scale (muscle pump quality)
  focusRating        Int?              // 1-5 scale (mind-muscle connection)
  overallRating      Int?              // 1-5 session satisfaction
  
  // === ENVIRONMENT ===
  environment        String?           // "home", "commercial_gym", "outdoor", "hotel", "travel"
  
  // === PERIODIZATION ===
  trainingPhase      String?           // "hypertrophy", "strength", "deload", "peaking", "maintenance"
  programName        String?           // "PPL Week 4", "Starting Strength", custom name
  mesocycleWeek      Int?              // Week 1-8 of current training block
  
  // === WARMUP ===
  warmupCompleted    Boolean           @default(false)  // Did user complete warmup phase?
  
  // === NOTES ===
  notes              String?
  
  // === RELATIONS ===
  userId             String
  user               User              @relation(fields: [userId], references: [id])
  routineId          String?
  routine            WorkoutRoutine?   @relation(fields: [routineId], references: [id])
  exercises          SessionExercise[]
  warmupLogs         WarmupLog[]       // Session-scoped warmup items
  
  @@index([userId, date])
  @@index([userId, year, month])
  @@index([status])
  @@index([dayOfWeek])
}

// Exercise instance within a session
model SessionExercise {
  id                 String          @id @default(uuid())
  order              Int             // Position in session
  
  // Exercise configuration (copied from RoutineExercise at session start)
  targetSets         Int             @default(3)
  targetReps         Int             @default(10)
  restSeconds        Int             @default(90)
  
  // Timing
  startedAt          DateTime?
  completedAt        DateTime?
  
  // Skip/Swap Tracking
  skipped            Boolean         @default(false)
  skipReason         String?         // "pain", "equipment", "fatigue", "time"
  swappedFromId      String?         // Reference if this replaced another exercise
  
  // Relations
  sessionId          String
  session            WorkoutSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exerciseId         String
  exercise           Exercise        @relation(fields: [exerciseId], references: [id])
  sets               SetLog[]
  
  @@index([sessionId])
}

// Atomic unit: one set of one exercise
model SetLog {
  id                 String          @id @default(uuid())
  setNumber          Int             // 1, 2, 3...
  
  // === PERFORMANCE ===
  targetReps         Int             // What was planned
  actualReps         Int             // What was achieved
  weight             Float           @default(0) // 0 = bodyweight
  weightUnit         String          @default("kg") // "kg" or "lbs"
  
  // === SUBJECTIVE METRICS ===
  rpe                Int?            // 1-10 Rate of Perceived Exertion
  painLevel          Int?            // 0-10, 0 = no pain
  painLocation       String?         // "elbow", "shoulder", "knee", etc.
  
  // === TIMING ===
  restTaken          Int?            // Actual rest in seconds before this set
  tempo              String?         // "3-1-2-0" format (eccentric-pause-concentric-pause)
  completedAt        DateTime        @default(now())
  
  // === FLAGS ===
  isWarmupSet        Boolean         @default(false)
  isDropSet          Boolean         @default(false)
  isFailure          Boolean         @default(false) // Went to technical failure
  
  // === NOTES ===
  formNotes          String?         // "felt unstable", "good squeeze", etc.
  
  // Relations
  sessionExerciseId  String
  sessionExercise    SessionExercise @relation(fields: [sessionExerciseId], references: [id], onDelete: Cascade)
  
  // Link to blocker if this set aggravated an injury
  aggravatedBlockerId String?
  aggravatedBlocker   PhysicalBlocker? @relation(fields: [aggravatedBlockerId], references: [id])
  
  @@index([sessionExerciseId])
  @@index([completedAt])
}

// ============================================
// BODY OBSERVABILITY (Blockers/Injuries)
// ============================================

enum BlockerStatus {
  ACTIVE      // Currently hurting
  RECOVERING  // Pain gone, but being careful
  RESOLVED    // Fully healed
  CHRONIC     // Permanent issue to manage
}

// Physical issues tracker (like Jira tickets for your body)
model PhysicalBlocker {
  id          String        @id @default(uuid())
  name        String        // "Golfer's Elbow", "Tight Left Hamstring"
  bodyPart    String        // "Right Elbow", "Lower Back", "Left Shoulder"
  
  status      BlockerStatus @default(ACTIVE)
  severity    Int           // 1-10 initial severity
  
  startDate   DateTime      @default(now())
  resolvedAt  DateTime?     // When the "ticket" was closed
  
  notes       String?       // "Hurts when gripping tight"
  
  // Relations
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  // History of severity changes
  entries     BlockerEntry[]
  
  // Sets that aggravated this blocker
  aggravatedByLogs SetLog[]
  
  @@index([userId, status])
}

// Severity history for a blocker (track recovery over time)
model BlockerEntry {
  id          String          @id @default(uuid())
  date        DateTime        @default(now())
  severity    Int             // 1-10 current severity
  notes       String?         // "Felt better after stretching"
  
  blockerId   String
  blocker     PhysicalBlocker @relation(fields: [blockerId], references: [id], onDelete: Cascade)
  
  @@index([blockerId, date])
}
